\chapter{Partial Enclosure Range Searching with Axis-Parallel Rectangles}
\label{:rectangles}

In this chapter, we begin with a simple environment for performing partial enclosure range searching. 
Even with this simplified model, we will be able to identify several challenges inherent to this problem domain and develop some techniques which we will use to solve many of the more complex problems.

We will present two variations of the \PERS{} problem in this chapter. 
Both use axis-parallel rectangles as their query and line segments as their input. 
In the first variation, the line segments will also be axis-parallel, whereas in Section~\ref{:rectangles:ao}, we allow segments of arbitrary orientation.

%------------------------------------------------------------------------------
\section{Axis-Parallel Segments}
\label{:rectangles:ap}

In this section, our input is a set of axis-parallel line segments in the plane and our queries are in the form of axis-parallel rectangles.
This is the simplest 2D environment on which we can perform \PERS{} as the objects and query region are both simple geometric objects, and we can rely on their fixed orientations while expressing equations about them. 
We will discuss only horizontal segments here.
The solution for vertical segments is identical, and we discuss how to combine the two approaches at the end of the section. We define the problem as follows.

\begin{problem}
Given a set of $n$ axis-parallel line segments in the plane, and a fixed parameter $\rho$ such that $0 < \rho \leq 1$, we want to identify those segments which are sufficiently enclosed by an axis-parallel query rectangle $Q$ so as to satisfy the partial enclosure property. 
A segment $s$ satisfies this property if and only if $|s \cap Q| \geq \rho \cdot |s|$.
\end{problem}


\subsection{Definitions}
\label{:rectangles:ap:defs}

Let $S$ be a set of $n$ axis-parallel line segments in the plane.
Each segment $s_i \in S$, $1 \leq i \leq n$ is defined by its two endpoints $p_i = (a_i, b_i)$ and $q_i = (c_i, d_i)$. 
Without loss of generality, we will assume that $p_i$ is the leftmost endpoint of $s_i$ (or the lower endpoint if $s_i$ is vertical). 
We define $l_i = |s_i|$ as the length of $s_i$; for horizontal segments the length is easily calculated as $l_i = c_i - a_i$. 
Our query $Q$ is given by its lower-left corner $(\alpha, \beta)$ and its upper-right corner $(\gamma, \delta)$. 
We say that $s_i \in_\rho Q$ if and only if $s_i$ satisfies the partial enclosure property w.r.t. $Q$, otherwise $s \not \in_\rho Q$.

For any $x$-coordinate, $\iline{x}$ is the vertical line through $x$. Similarly, for any $y$-coordinate, $\iline{y}$ is the horizontal line through $y$. For example, $\iline{\beta}$ is the horizontal line through the bottom boundary of $Q$, while $\iline{a_i}$ is the vertical line through $a_i$, and thus, through the left endpoint of $s_i$. Finally, we define $\iline{s_i}$ as the line through the segment $s_i$; for a horizontal segment $s_i$, the lines $\iline{s_i}$, $\iline{b_i}$, and $\iline{d_i}$ are all equivalent. When we focus on any single, general segment, we omit the $i$ subscripts for clarity.


\subsection{Decomposing the Problem}
\label{:rectangles:ap:approach}

\begin{figure}[t]
\centering
\includegraphics[width=1.00\columnwidth]{figures/fig_oo_cases}
\caption[The different cases of axis-parallel segments.]{An axis-parallel query on axis-parallel segments. Different cases of horizontal segments interacting with the query region are shown.}
\label{:fig:rectangles:ap:cases}
\end{figure}

As Figure~\ref{:fig:rectangles:ap:cases} illustrates, there are several cases to consider regarding how a horizontal segment $s \in S$ may interact with $Q$. Cases $(1)$, $(2)$, and $(3)$, where $s$ is entirely left, entirely within, or entirely right of $Q$, respectively, are exactly an instance of  standard range searching problems where we look to find elements which are completely inside or completely outside of a query region.  

Case $(4)$ considers segments where $s$ crosses only the left boundary of $Q$. 
Looking at it another way, $s$ has its left endpoint left of $\alpha$, while its right endpoint satisfies $\alpha \leq c \leq \gamma$.
We further subdivide case $(4)$ into cases where, for a fixed value of $\rho$, $s \in_\rho Q$ in case $(4a)$ and $s \not \in_\rho Q$ in case $(4b)$.
Cases $(5a)$ and $(5b)$ are similar to cases $(4a)$ and $(4b)$, but with respect to $\gamma$. 
Specifically, $s$ falls into case $(5a)$ or $(5b)$ when $\alpha \leq a \leq \gamma$ and $c > \gamma$. 

In case $(6)$, $s$ crosses both the left and right boundaries of $Q$, and, crucially, neither $p$ nor $q$ are inside $Q$. 
Just as in cases $(4)$ and $(5)$, $s$ falls into case $(6a)$ if $s \in_\rho Q$ and into case $(6b)$ if $s \not \in_\rho Q$.

Our goal is to identify all segments belonging to cases $(2)$, $(4a)$, $(5a)$, and $(6a)$, and none of the segments belonging to any other case.

Our approach to solving this problem involves restricting and classifying segments step-by-step until, for some subset of segments, we are able to identify an expression representing its partial enclosure property.  Our solution proceeds as follows.

\paragraph{Step 1.} As we are only considering horizontal segments for now, we only need to consider those segments which are neither above nor below $Q$, since they are the only ones which can intersect $Q$ at all. Let $S_1 = \{ s \in S \st \beta \leq b \leq \delta\}$. 

\paragraph{Step 2.} Identify those segments which are not ``too long''.  
Let $w = \gamma - \alpha$ be the width of $Q$.
Any segment $s$ with length $l$ where $l > \frac{w}{\rho}$ can never have its partial enclosure property satisfied.
Let $S_2 = \{ s \in S_1 \st l \leq \frac{w}{\rho} \}$.

\paragraph{Step 3.} Partition the remaining segments according the location of their left endpoint with respect to $\alpha$.
Specifically, let $S_L = \{s \in S_2 \st a < \alpha \}$ and let $S_R = \{ s \in S_2 \st a \geq \alpha \}$.

\paragraph{Step 4.} Test an appropriate partial enclosure expression to determine if $s$ should be counted.
For segments whose left endpoint is left of $\alpha$, we want to ensure that ``not too much of $s$ is outside of $Q$''; Let $S_L' = \{ s \in S_L \st \alpha - a < (1 - \rho) \cdot l\}$.
For segments whose left endpoint is at or right of $\alpha$, we want to ensure that ``enough of $s$ is inside $Q$''; Let $S_R' = \{ s \in S_R \st \gamma - a \geq  \rho l \}$.
Our claim is that the subset of segments satisfying the partial enclosure property is $S_\rho = S_L' \cup S_R'$. 

\begin{proof}
The correctness of Steps 1 and 2 is straight-forward, and Step 3 merely partitions the remaining segments. 
Thus, we focus on Step 4 and show that, for each case, a segment belonging to that case is correctly accepted or rejected.

Consider the segments in $S_L$, which we check against the partial enclosure expression $\alpha - a < (1 - \rho) \cdot l$ measuring how much of $s$ is outside of $Q$. 
Segments in case $(1)$ have $\alpha - a > l$, so they are correctly rejected. 
Segments in cases $(4a)$ and $(4b)$ are accepted or rejected straight-forwardly by this condition as we measure precisely how much of $s$ is outside of $Q$, and thus, how much is inside. 

The most interesting cases are $(6a)$ and $(6b)$, and they are the motivation behind Step 2.
After that step, for any segment we are still considering, we know that $l \leq \frac{w}{\rho}$. 
This allows us to avoid explicitly deciding if $s$ crosses $\gamma$, since if not too much of $s$ is left of $Q$, then $s$ either crosses only $\alpha$ and case $(4)$ holds, or it crosses $\alpha$ and $\gamma$, $|s \cap Q| = w$, and $w$ is sufficient.

Next, we consider the segments in $S_R$, which we check against the partial enclosure expression $\gamma - a \geq  \rho l$. 
For case $(2)$, $\gamma - a \geq l$, and since $l \geq \rho l$ for all valid values of $\rho$, these segments are accepted.
On the other hand, for case $(3)$, $\gamma - a < 0$ and all such segments are rejected. 
In the final cases, $(5a)$ and $(5b)$, the value of $|s \cap Q|$ is measured directly, and the segments are classified appropriately.

\end{proof}


\subsection{Construction and Analysis}
\label{:rectangles:ap:analysis}

Each step of Section~\ref{:rectangles:ap:approach} includes or excludes segments by examining inequalities.
Each inequality is comprised of segment parameters which we know during preprocessing, and a single query variable expression, i.e., an expression consisting only of query variables which can be calculated at query time. 
To perform the query, we map each segment to a point in 4D where each component of the point is based on the segment input parameters corresponding to one of our inequalities, and map the query variables given by $Q$ to a 4D box.
The query can then be answered using a multi-level range tree.

Recall that for every $s \in S$, we know $a$, $b$, and $l$, which are the $x$ and $y$-coordinates of the left endpoint, and the length of the segment, respectively. 
The query region $Q$ has width $w = \gamma - \alpha$. Let $v$ be the 4D point we create which corresponds to $s$, constructed as follows.

The first two conditions we need to check are the same for all cases. 
We first isolate segments based directly on their $y$-coordinate; thus, the first component of $v$ will be $b$, and the first component of our 4D query box will be $[\beta, \delta]$.
We next want to include only segments where $l \leq \frac{w}{\rho}$. We can rewrite this as $\rho l \leq w$. 
Thus, the second component of $v$ will be $\rho l$, and the second component of our query box will be $(0, w]$.

Our segments are next classified according to which side of $\alpha$ their left endpoints are found.
We set the third component of $v$ to $a$.
The third component of the query box will be either $(-\infty, \alpha)$ or $[\alpha, \infty)$. Our overall query must execute both cases and combine the results later.

Finally, we need to check the partial enclosure expressions.
We have two cases to check. The first expression is for segments whose left endpoint is left of $\alpha$.
The partial enclosure expression $\alpha - a < (1 - \rho) \cdot l$ can be rewritten as $\alpha < a + (1-\rho) \cdot l$.
Therefore, we set the fourth component of $v$ to $a + (1 - \rho) \cdot l$, and the fourth component of the query box to $(\alpha, \infty)$.
All together, to answer this case, every segment $s_i \in S$ is mapped to the 4D point 
\[ 
v_i = (b_i, \rho l_i, a_i, a_i + (1-\rho) \cdot l_i)
\]

\noindent and is queried by the 4D query box
\[
[\beta, \delta] \times (0, w] \times (-\infty, \alpha) \times (\alpha, \infty)
\]

The next expression is for segments whose left endpoints are at or right of $\alpha$. 
The partial enclosure expression $\gamma - a \geq \rho l$ can be rewritten as $\gamma \geq a + \rho l$. 
Therefore, we set the fourth component of $v$ to $a + \rho l$, and the fourth component of the query box to $(-\infty, \gamma]$.  
All together, to answer this case, every segment $s_i \in S$ is mapped to the point
\[
v_i' = (b_i, \rho l_i, a_i, a_i + \rho l_i)
\]

\noindent and is queried by the box
\[
[\beta, \delta] \times (0, w] \times [\alpha, \infty) \times (-\infty, \gamma]
\]

By Corollary~\ref{cor:rangetree}, we can answer either of these queries by constructing a multi-level range tree.
As our points are in 4D, such a tree requires $\BigOh{n \log^3{n}}$ time and space for preprocessing and can answer queries in $\BigOh{\log^3{n}}$ time.
To find all horizontal segments satisfying their partial enclosure property, we need to perform both queries and combine the results.  

A second data structure and query does not change the asymptotic requirements of the algorithm, however, we note that since both point mappings start with the same three components, we can save a constant factor of space by sharing the first three levels of the multi-level range tree. 
At the third level of the tree, we create \emph{two} associated structures, one for each of the partial enclosure expressions, and query each one as needed. 
In a similar way, we can save a constant factor of time during our queries, since both queries begin with the same two values.


\paragraph{Vertical Segments.} The method for querying vertical segments is very similar to that for horizontal segments, except that we care about the height of $Q$ rather than its width, and need to consider symmetric coordinates of each segment when going through each of the 4 steps.
Preprocessing and querying this extra orientation does not change our asymptotic analysis, since the number of orientations remains fixed.


\paragraph{Combining the Steps.} We maintain the structures necessary for both the horizontal and vertical portions of the query.
At query time, each structure is queried independently. 
The subtrees found in the last level of each structure contain matching segments, and these results can be combined in a straight-forward manner for counting or reporting queries.
The following theorem summarizes the solution.

\begin{theorem}
\label{th:ap}
Given a set of $n$ axis-parallel line segments, we can identify a set of disjoint subsets containing all segments which satisfy the partial enclosure property for an axis-parallel query rectangle in $\BigOh{\log^3{n}}$ time, with a data structure requiring $\BigOh{n\log^3{n}}$ preprocessing time and space.
\end{theorem}

%------------------------------------------------------------------------------
\section{Arbitrarily-Oriented Segments}
\label{:rectangles:ao}

In this section, we relax the restriction that all segments should be axis-parallel, allowing each segment to have any arbitrary orientation with respect to one another. 
It does not matter if segments intersect. 
The problem statement is as follows.

\begin{problem}
Given a set of $n$ arbitrarily-oriented line segments in the plane, and a fixed parameter $\rho$ such that $1/2 < \rho \leq 1$, we want to identify those segments which are sufficiently enclosed by an axis-parallel query rectangle $Q$ so as to satisfy the partial enclosure property. 
A segment $s$ satisfies this property if and only if $|s \cap Q| \geq \rho \cdot |s|$.
\end{problem}

Throughout this section, the query region $Q$ and the set of segments $S$ follow the same definitions as in Section~\ref{:rectangles:ap:defs}. 
Observe that the definition for $\rho$ is different than in Section~\ref{:rectangles:ap}; we discuss this difference in the conclusion of this chapter.


\subsection{Decomposing the Problem}
\label{:rectangles:ao:approach}

There are three principal cases to consider; those segments which have both endpoints inside $Q$, those with only one endpoint inside $Q$, and those with both endpoints outside $Q$.  

The first case, where both endpoints are inside $Q$, is answered by mapping each segment to a point in 4D space and then using a multi-level range tree, much like we did in the previous section.  Specifically, we map each segment $s_i$ to the point $v_i = (a_i, b_i, c_i, d_i)$. The query $Q$ is mapped to the following 4D box
\[
[\alpha, \gamma] \times [\beta, \delta] \times [\alpha, \gamma] \times [\beta, \delta]
\]

In essence, we are just testing to ensure that both endpoints appear within query rectangle.
The second case, where only one endpoint is inside $Q$ is solved using the same method as the first case, but on a ``virtual'' segment.
For each segment $s_i$, we create virtual segments which share endpoints with $s_i$.
Specifically, we define the segment $s_{i,p} \subseteq s_i$ where $s_i$ and $s_{i,p}$ share the endpoint $p_i$ and $|s_{i,p}| = \rho \cdot |s_i|$.
Likewise, we define the segment $s_{i,q} \subseteq s_i$ where $s_i$ and $s_{i,q}$ share the endpoint $q$ and $|s_{i,q}| = \rho \cdot |s_i|$.

Then, as a direct consequence of their construction, if $s_{i,p} \in Q$, then $s_i \in_\rho Q$, and if $s_{i,q} \in Q$, then $s_i \in_\rho Q$.
Counting both cases will double-count any segment which has both endpoints in $Q$, so we subtract accordingly.

We can query these higher dimensional points by applying the multi-level range tree method given by Theorem~\ref{th:rangetree}.


\subsection{Handling Endpoints Outside of $Q$}
\label{:rectangles:ao:bothout}

The case where both endpoints of a segment are outside $Q$ is the most challenging case to handle.
We begin by partitioning the space around $Q$ into 8 regions by extending lines through its horizontal and vertical boundaries. 
These regions are labelled anti-clockwise from left-middle as $I, II, \ldots, VIII$; see Figure~\ref{fig:rectangles:ao:regions}. 
Any segment which passes through $Q$ but which has neither endpoint in $Q$ will have its endpoints in two distinct regions. 
Not every pair of regions is legal, however.
For example, a segment with one endpoint in region $I$ and another in region $II$ cannot intersect $Q$.

\begin{figure}[t]
\begin{center}
  \includegraphics[width=0.75\textwidth]{figures/fig_ao_regions}
  \caption{The 8 regions surrounding $Q$.}
  \label{fig:rectangles:ao:regions}
\end{center}
\end{figure}

A segment which passes through $Q$ may involve any of the following pairs of regions, falling into 4 classes:

\begin{enumerate}[i.]
\item Parallel sides: $(I, V), (III, VII)$.
\item Perpendicular sides: $(I, III), (III, V), (V,VII), (VII, I)$.
\item Diagonal to Orthogonal: $(II, V)$, $(II, VII)$, $(IV, I)$, $(IV, VII)$, $(VI, I)$, \newline $(VI, III)$, $(VIII, III)$, $(VIII, V)$.
\item Diagonal to Diagonal: $(II, VI), (IV, VIII)$.
\end{enumerate}

We will query for each case separately and combine our results at the end. 
For a segment $s \in S$, we can identify the regions of $p$ and $q$ using a 4-dimensional orthogonal range search. 
This classification determines which partial enclosure expressions we need to test in the second phase of the query. We develop expressions for each case below. 

In all cases, we require the following additional definitions. Let $o_i = (e_i, f_i)$ be the centrepoint of $s_i$.
We define the function $d(u,v)$ as the Euclidean distance between any two points $u$ and $v$.
We define $L_i = d(p_i, q_i)/2$ to be exactly half the length of $s_i$ (therefore, $d(p_i, o_i) = d(q_i, o_i) = L_i$).
As with our previous definitions, when we discuss any single, general segment $s \in S$, we will drop the $i$ subscripts for clarity.


%------------------------------------------------------------------------------
\subsubsection{Class (i); e.g., $(p, q) \in (I, V)$}
\label{:rectangles:ao:class1}

Class (i) is concerned with segments which cross parallel sides of $Q$. 
We present the details of the partial enclosure property for the case where $p \in I$ and $q \in V$; the solution for the $(III, VII)$ case is similar.

\begin{figure}[t]
\begin{center}
  \includegraphics[width=0.80\textwidth]{figures/fig_ao_case1}
  \caption{An example of a segment in class (i), case $(I, V)$.}
  \label{fig:rectangles:ao:case1}
\end{center}
\end{figure}

Let $s \in S$ be a segment belonging to class (i), case $(I, V)$.
Assume for now that $o \in Q$ and let $p'$ ($q'$) be the intersection of $s$ with $Q$ closest to $p$ ($q$).  
Let $u = (a, f)$ be the point vertically aligned with $p$ and horizontally aligned with $o$. Then, $\Delta p u o$ is a right triangle, and $u' = (\alpha, f)$ is the intersection point of $\iline{u o}$ with the boundary of $Q$.  
The triangle $\Delta p' u' o$ is a right triangle and is similar to $\Delta p u o$. 
Likewise, let $v = (c, f)$ be the point vertically aligned with $q$ and horizontally aligned with $o$.
Then, $\Delta q v o$ is a right triangle, and $v' = (\gamma, f)$ is the intersection point of $\iline{v o}$ with the boundary of $Q$. 
The triangle $\Delta q' v' o$ is a right triangle and is similar to $\Delta q v o$. See Figure~\ref{fig:rectangles:ao:case1}.

We will test the partial enclosure property by checking that ``not too much of $s$ is outside of $Q$''. Specifically, we need to find those segments where $\frac{d(p, p') + d(q, q')}{d(p, q)} \leq 1 - \rho$. By similarity of triangles, 
\[ 
\frac{d(p, p')}{d(p, o)} = \frac{d(p, p')}{L} = \frac{d(u, u')}{d(u, o)} = \frac{2 d(u, u')}{2 d(u, o)} = \frac{2(\alpha - a)}{c - a}
\]

\noindent and 
\[ 
\frac{d(q, q')}{d(q, o)} = \frac{d(q, q')}{L} = \frac{d(v, v')}{d(v, o)} = \frac{2 d(v, v')}{2 d(v, o)} = \frac{2(c - \gamma)}{c - a}
\]

\noindent Thus,
\[
\begin{split} 
\frac{d(p, p') + d(q, q')}{d(p, q)}
%
&= \frac{d(p, p') + d(q, q')}{2L} \\
%
&= \frac{1}{2} \left ( \frac{d(p, p')}{L} + \frac{d(q, q')}{L} \right ) \\
%
&= \frac{1}{2} \left ( \frac{2(\alpha - a)}{c - a} + \frac{2(c - \gamma)}{c - a} \right ) \\
%
&= \frac{\alpha - a}{c - a} + \frac{c - \gamma}{c - a} \\
%
&= \frac{\alpha - a + c - \gamma}{c - a} \\
%
&= 1 + \frac{\alpha - \gamma}{c - a} \\
%
\end{split}
\]

\noindent Therefore, the inequality $\frac{d(p, p') + d(q, q')}{d(p, q)} \leq 1 - \rho$ can instead be evaluated as $1 + \frac{\alpha - \gamma}{c - a} \leq 1 - \rho$, which is based on two query variables $\alpha$ and $\gamma$.  
We can further simplify the expression to
\[ 
\rho(c - a) \leq \gamma - \alpha
\]

\noindent where the value of $\gamma - \alpha$ is a single query variable expression calculated at query time.  This inequality can therefore be checked by an orthogonal range search similar to the techniques used in Section~\ref{:rectangles:ap:approach}.

When $o \not \in Q$, we cannot construct similar triangles in the same way, since we require the points of intersection between the triangles and $Q$.  
However, since we know that any segment which \emph{is} sufficiently enclosed by $Q$ will have its centrepoint in $Q$, it is enough for our purposes if our test condition always reports a failure when $o$ is outside of $Q$.

We know that both $p$ and $q$ are outside of $Q$, so it must be the case that $\frac{\alpha - a}{c - a} > 0$ and $\frac{c - \gamma}{c - a} > 0$. Observe that if $o$ is left of $\alpha$, then $\frac{\alpha - a}{c - a} > 1/2$. Likewise, if $o$ is right of $\gamma$, then $\frac{c - \gamma}{c - a} > 1/2$. Therefore, the sum $\frac{\alpha - a}{c - a} + \frac{c - \gamma}{c - a} > 1/2$ and is strictly larger than any allowable value for $(1 - \rho)$, resulting in the segment being rejected as desired.


%------------------------------------------------------------------------------
\subsubsection{Class (ii); e.g., $(p, q) \in (I, III)$}
\label{:rectanges:ao:class2}

Class (ii) is concerned with segments which cross perpendicular sides of $Q$. 
We present the details of the partial enclosure property for the case where $p \in I$ and $q \in III$; the solutions for other cases of class (ii) are similar. 
These expressions are not so different from the ones given in class (i), however we will see that we get two query variable expressions instead of one, and this has ramifications for how we will construct our data structure.

\begin{figure}[t]
\begin{center}
  \includegraphics[width=0.80\textwidth]{figures/fig_ao_case2}
  \caption[An example of a segment in class (ii), case $(I, III)$.]{An example of a segment in class (ii), case $(I, III)$. This particular segment is not sufficiently enclosed by $Q$ for any allowable value of $\rho$.}
  \label{fig:rectangles:ao:case2}
\end{center}
\end{figure}

Assume for now that $o \in Q$ and let $p'$ ($q'$) be the intersection of $s$ with $Q$ closest to $p$ ($q$).
Let $u = (a, f)$ be the point under $p$ directly left of $o$.
Then, $\Delta p u o$ is a right triangle, and $u' = (\alpha, f)$ is the intersection point of $\iline{u o}$ with the boundary of $Q$.
The triangle $\Delta p' u' o$ is a right triangle and is similar to $\Delta p u o$.
Likewise, let $v = (e, d)$ be the point left of $q$ directly under $o$.
Then, $\Delta q v o$ is a right triangle, and $v' = (e, \beta)$ is the intersection point of $\iline{v o}$ with the boundary of $Q$.
The triangle $\Delta q' v' o$ is a right triangle and is similar to $\Delta q v o$.
See Figure~\ref{fig:rectangles:ao:case2}.

We need to find those segments where $\frac{d(p, p') + d(q, q')}{d(p, q)} \leq 1 - \rho$. By similarity of triangles, 
\[ 
\frac{d(p, p')}{d(p, o)} = \frac{d(p, p')}{L} = \frac{d(u, u')}{d(u, o)} =  \frac{2 d(u, u')}{2 d(u, o)} = \frac{2(\alpha - a)}{c - a}
\]

\noindent and 
\[ 
\frac{d(q, q')}{d(q, o)} = \frac{d(q, q')}{L} = \frac{d(v, v')}{d(v, o)} = \frac{2 d(v, v')}{2 d(v, o)} = \frac{2(\beta - d)}{b - d}
\]

\noindent Thus,
\[
\begin{split} 
\frac{d(p, p') + d(q, q')}{d(p, q)}
%
&= \frac{d(p, p') + d(q, q')}{2L} \\
%
&= \frac{1}{2} \left ( \frac{d(p, p')}{L} + \frac{d(q, q')}{L} \right ) \\
%
&= \frac{1}{2} \left ( \frac{2(\alpha - a)}{c - a} + \frac{2(\beta - d)}{b - d} \right ) \\
%
&= \frac{\alpha - a}{c - a} + \frac{\beta - d}{b - d} \\
%
\end{split}
\]

\indent Therefore, the inequality $\frac{d(p, p') + d(q, q')}{d(p, q)} \leq 1 - \rho$ can be tested by checking the equivalent inequality $\frac{\alpha - a}{c - a} + \frac{\beta - d}{b - d} \leq 1 - \rho$, defined on the two query variables $\alpha$ and $\beta$. 
We will perform this test using a half-plane range query. 
To construct an appropriate dual-space for the half-plane query, we reorder the expression as follows:
\[
\begin{split}
\frac{\alpha - a}{c - a} + \frac{\beta - d}{b - d} &\leq 1 - \rho \\
%
\frac{\alpha}{c-a} - \frac{a}{c-a} + \frac{\beta}{b-d} - \frac{d}{b-d} &\leq 1 - \rho \\
%
\alpha \cdot \frac{1}{c-a} + \beta \cdot \frac{1}{b-d} &\leq (1 - \rho) + \frac{a}{c-a} + \frac{d}{b-d} \\
%
\alpha + \beta \cdot \frac{c-a}{b-d} &\leq \left ( (1 - \rho) + \frac{d}{b-d} \right ) \cdot (c-a) + a \\
%
\end{split}
\]

\noindent We then map each segment $s$ to a point with coordinates
\[
\left (\frac{c-a}{b-d}, \left ( (1 - \rho) + \frac{d}{b-d} \right ) \cdot (c-a) + a \right )
\]

\noindent In this space, segments matching the partial enclosure expression correspond to dual-points satisfying the half-plane $y \geq \beta x + \alpha$

Just as in class (i), when $o \not \in Q$, we cannot construct appropriate similar triangles for our method, but it remains sufficient for the expressions to reject any such segment. Observe that if $o$ is left of $\alpha$, then $\frac{\alpha - a}{c - a} > 1/2$. Likewise, if $o$ is below $\beta$, then $\frac{\beta - d}{b - d} > 1/2$. Their sum is therefore strictly greater than $1/2$, and larger than any allowable value for $(1 - \rho)$, rejecting the segment as desired.


%------------------------------------------------------------------------------
\subsubsection{Class (iii); e.g., $(p, q) \in (I, IV)$}
\label{:rectanges:ao:class3}

Class (iii) is concerned with segments which have one endpoint in a corner region of $Q$, and the other endpoint in an orthogonal region of $Q$. 
We present the details of the partial enclosure property for the case where $p \in I$ and $q \in IV$; the solutions for other cases of Class (iii) are similar.

\begin{figure}[t]
\begin{center}
  \includegraphics[width=0.45\textwidth]{figures/fig_ao_case3}
  \hspace{1.0em}
  \includegraphics[width=0.45\textwidth]{figures/fig_ao_case3b}
  \caption[An example of a segment in class (iii), case $(I, IV)$.]{An example of segments from each subcase of class (iii), case $(I, IV)$. The blue follows the proper handling of the subcase, while the red shows the incorrect handling.}
  \label{fig:rectangles:ao:case3}
\end{center}
\end{figure}

Assume for now that $o \in Q$. We need to consider two subcases: (a) $s$ crosses $\alpha$ and $\beta$ or (b) $s$ crosses $\alpha$ and $\gamma$. See Figure~\ref{fig:rectangles:ao:case3} for examples. Subcase (a) is very nearly exactly the example presented for class (ii). In that case, the only use of the fact that the endpoints of $s$ were located in regions $I$ and $III$ was to imply that $s$ crossed $\alpha$ and $\beta$. As such, this subcase can use the same expression for testing $s$. Likewise, subcase (b) is similar to the example presented for class (i) and can use exactly that expression for testing $s$.

Our initial query for identifying the regions of $p$ and $q$ does not allow us to differentiate between subcases.
Instead, we will check both subcases simultaneously.
From class (i) and class (ii), we have the following expressions:
\[ 
\frac{\alpha - a}{c - a} + \frac{c - \gamma}{c - a} \leq 1 - \rho
\]

\noindent and
\[ 
\frac{\alpha - a}{c - a} + \frac{\beta - d}{b - d} \leq 1 - \rho
\]

\noindent If $s$ belongs to subcase (a), then $\frac{c - \gamma}{c - a} \leq \frac{\beta - d}{b - d}$ since $\gamma$ is farther right than the point where $s$ exits $Q$.
Likewise, in subcase (b), $\frac{\beta - d}{b - d} \leq \frac{c - \gamma}{c - a}$.
Therefore, in either subcase, the result of the correct expression is larger than the incorrect one, allowing us to correctly reject segments by blindly checking both conditions.
This also holds when $o \not \in Q$, since the expression for at least one subcase would exclude the segment.


% -----------------------------------------------------------------------------
\subsubsection{Class (iv); e.g., $(p, q) \in (II, VI)$}
\label{:rectanges:ao:class4}

Class (iv) is concerned with segments whose endpoints appear in diagonally opposite corner regions of $Q$. 
We present the details of the partial enclosure property for the case where $p \in II$ and $q \in VI$; the solution for the $(VI, VIII)$ case is similar.

\begin{figure}[t]
\begin{center}
  \includegraphics[width=0.45\textwidth]{figures/fig_ao_case4a}
  \hspace{1.0em}
  \includegraphics[width=0.45\textwidth]{figures/fig_ao_case4b}

  \vspace{2.0em}
  
  \includegraphics[width=0.45\textwidth]{figures/fig_ao_case4c}
  \hspace{1.0em}
  \includegraphics[width=0.45\textwidth]{figures/fig_ao_case4d}

  \caption[An example of a segment in class (iv), case $(II, VI)$.]{An example of segments from each subcase of class (iv), case $(II, VI)$. The blue lines show the proper handling of each.}
  \label{fig:rectangles:ao:case4}
\end{center}
\end{figure}

Assume for now that $o \in Q$. As with class (iii), we need to consider several subcases depending on which sides of $Q$ are intersected by $s$:

\begin{enumerate}[(a)]
\item $s$ crosses $\alpha$ and $\delta$,
\item $s$ crosses $\alpha$ and $\gamma$,
\item $s$ crosses $\beta$ and $\delta$,
\item $s$ crosses $\beta$ and $\gamma$,
\end{enumerate}

See Figure~\ref{fig:rectangles:ao:case4} for examples of each subcase. 
Our initial query for identifying the regions of $p$ and $q$ does not allow us to differentiate between subcases. 
However, it is sufficient to check all subcases simultaneously. The expression for subcase (b) comes directly from class (i).
Using similar techniques as we did for classes (i) and (ii), we develop the following set of partial enclosure expressions:

\begin{align*}
& (a) \quad \frac{\alpha - a}{c - a} + \frac{d - \delta}{d - b} \leq 1 - \rho
& (b) \quad \frac{\alpha - a}{c - a} + \frac{c - \gamma}{c - a} \leq 1 - \rho \\
& (c) \quad \frac{\beta  - b}{d - b} + \frac{d - \delta}{d - b} \leq 1 - \rho  
& (d) \quad \frac{\beta  - b}{d - b} + \frac{c - \gamma}{c - a} \leq 1 - \rho \\
\end{align*}

Subcases (b) and (c) can be simplified to orthogonal range queries, while subcases (a) and (d) will need to be mapped to appropriate dual-spaces and queried with half-planes as in class (ii).

To illustrate that checking all four conditions simultaneously yields correct results, consider what happens if $s$ belongs to subcase (a), where $s$ crosses $\alpha$ and $\delta$. In these circumstances, $u'$ is above $\beta$, and we have that $\frac{\alpha - a}{c - a} \geq \frac{\beta - b}{d - b}$.  Likewise, $v'$ is left of $\gamma$, so $\frac{d - \delta}{d - b} \geq \frac{c - \gamma}{c - a}$.  Therefore, the expression for (a) dominates the other expressions (i.e., $\text{(a)} \geq \text{(b)}$, $\text{(a)} \geq \text{(c)}$, and $\text{(a)} \geq \text{(d)}$), allowing us to identify qualifying segments for subcase (a) by blindly checking all conditions. This property is true for segments belonging to subcases (b), (c), and (d) as well. Furthermore, this test also holds when $o \not \in Q$, since the expression for at least one subcase would exclude the segment.


%------------------------------------------------------------------------------
\subsection{Construction and Analysis}
\label{:rectangles:ao:analysis}

Our method takes a very case-by-case approach to solving the problem, and executes in two phases.
The first phase must classify segments belonging to each of the 16 pairs of regions around $Q$ which are of interest. 
For each case, the second phase must then identify those segments satisfying their respective partial enclosure property. 

Broadly, our solution to this problem uses a multi-level range tree (Section~\ref{:prelim:range-trees}) for the classification phase, and a combination of range trees and canonical subsets structures (Section~\ref{:prelim:chan}) to check the partial enclosure expressions. 

Identifying the segments which satisfy each case of each class is a matter of testing a set of several conditions, all of which must be true. The order that we test the conditions in makes no difference to the correctness of the algorithm, but can have an impact on its space requirements.

\paragraph{Class (i), $(p, q) \in (I, V)$ case.} 
To identify these segments, we need to find those segments whose endpoints are in the appropriate regions, and which satisfy the single, orthogonal partial enclosure expression for the case. 
Using an approach similar to Section~\ref{:rectangles:ap:analysis}, for each $s_i \in S$, we construct a corresponding 5D point $v_i$ as follows.
\[
v_i = (a_i, b_i, c_i, d_i, \rho(c_i - a_i))
\]

\noindent We then query these points with the 5D box:
\[
(-\infty, \alpha) \times [\beta, \delta] \times (\gamma, \infty) \times [\beta, \delta] \times (-\infty, \gamma - \alpha]
\]

\noindent The following lemma summarizes how we can query this class of segments.

\begin{lemma}
\label{lem:ao:class1:v}
Given a set of $n$ line segments, we can identify a set of disjoint subsets containing all segments belonging to class (i) \emph{and} which satisfy their partial enclosure property in $\BigOh{\log^4{n}}$ time using a data structure requiring $\BigOh{n\log^4{n}}$ preprocessing time and space.
\end{lemma}

\paragraph{Class (ii), $(p, q) \in (I, III)$ case.} 
As with all cases, part of the problem involves first identifying those segments with endpoints in the appropriate regions.
In this case, however, the partial enclosure expression is evaluated using a half-plane query.

The classification portion is performed just as we have seen above. We map each segment to the 4D point $v_i = ( a_i, b_i, c_i, d_i )$.
The partial enclosure expression will be queried by the dual-space we developed in Section~\ref{:rectanges:ao:class2}. 
For each $s_i \in S$, we define $h_i = \left ( \frac{c - a}{b - d}, \left ( (1 - \rho) + \frac{d}{b-d} \right ) \cdot (c-a) + a \right )$.
We need to construct a data structure which can answer queries on pairs $(v_i, h_i)$.

By Theorem~\ref{th:rangetree}, we can query the classification component using a range tree according to the following lemma.
\begin{lemma}
\label{lem:ao:class2:v}
Given a set of $n$ line segments, we can identify a set of disjoint subsets containing all segments belonging to class (ii) in $\BigOh{\log^3{n}}$ time using a data structure requiring $\BigOh{n\log^3{n}}$ preprocessing time and space.
\end{lemma}

By Theorem~\ref{th:chan}, we can query the half-plane component of our query objects using a canonical subsets data structure, giving the following lemma.

\begin{lemma}
\label{lem:ao:class2:h}
Given a set of $n$ line segments, we can identify a set of disjoint subsets containing all segments satisfying a half-plane representation of a partial enclosure expression in $\BigOh{\sqrt{n}\log{n}}$ time, using a data structure requiring $\BigOh{n\log{n}}$ preprocessing time and space.
\end{lemma}

Since the order that we check our conditions in does not affect correctness, we will check the half-plane condition first, then the endpoint classification.  
By Corollary~\ref{cor:multichan}, we can accomplish this by associating a classification structure with each subset of the half-plane structure. The resulting structure is summarized by the following lemma.

\begin{lemma}
\label{lem:ao:class2:c}
Given a set of $n$ line segments, we can identify a set of disjoint subsets containing all segments belonging to class (ii) \emph{and} which satisfy their partial enclosure property in $\BigOh{\sqrt{n}\log^4{n}}$ time using a data structure requiring $\BigOh{n\log^4{n}}$ preprocessing time and space.
\end{lemma}


\paragraph{Class (iii); $(p, q) \in (I, IV)$ case.} 
This case can use the same orthogonal structure that we developed in Lemma~\ref{lem:ao:class1:v} and the same half-plane expression as in Lemma~\ref{lem:ao:class2:h}. 
One component of the query box needs to be updated to account for region IV, giving the following.
\[
(-\infty, \alpha) \times [\beta, \delta] \times (\gamma, \infty) \times (-\infty, \beta) \times (-\infty, \gamma - \alpha]
\]

By Corollary~\ref{cor:multichan}, we can combine these two data structures to create a new structure which can answer this case as summarized by the following lemma.

\begin{lemma}
\label{lem:ao:class3:c}
Given a set of $n$ line segments, we can identify a set of disjoint subsets containing all segments belonging to class (iii) \emph{and} which satisfy their partial enclosure property in $\BigOh{\sqrt{n}\log^5{n}}$ time using a data structure requiring $\BigOh{n\log^5{n}}$ preprocessing time and space.
\end{lemma}


\paragraph{Class (iv); $(p, q) \in (II, VI)$ case.} 
This case has the largest number of partial enclosure expressions which need checking, in addition to the usual endpoint classification step. 
As a result, it will be the largest data structure to build.

The basic steps are just as in the last three cases. 
To cover endpoint classification and the two orthogonal partial enclosure expressions, we will use a data structure and query box similar to Lemma~\ref{lem:ao:class1:v}, but extended to 6D to cover the extra partial enclosure expression.
We then apply Lemma~\ref{lem:ao:class2:h} and Corollary~\ref{cor:multichan} twice to handle the two half-plane partial enclosure expressions and associate the orthogonal range tree. 
The entire structure for this case is summarized by the following lemma.

\begin{lemma}
\label{lem:ao:class4:c}
Given a set of $n$ line segments, we can identify a set of disjoint subsets containing all segments belonging to class (iv) \emph{and} which satisfy their partial enclosure property in $\BigOh{\sqrt{n}\log^7{n}}$ time using a data structure requiring $\BigOh{n\log^7{n}}$ preprocessing time and space.
\end{lemma}


\paragraph{Combining the Steps.} 

Querying the entire environment requires us to create the structures for handling the cases where one or both endpoints of a line segment lie entirely inside a query $Q$, as well as the structures for each of the cases when both endpoints lie outside of $Q$. 
Overall, this process is dominated by the structure required for the class (iv) segments. 
The following theorem summarizes the overall solution.

\begin{theorem}
\label{th:ao}
Given a set of $n$ arbitrarily-oriented line segments, we can identify a set of disjoint subsets containing all segments which satisfy the partial enclosure property for an axis-parallel query rectangle in $\BigOh{\sqrt{n}\log^7{n}}$ time, using a data structure requiring $\BigOh{n\log^7{n}}$ preprocessing time and space.
\end{theorem}


%------------------------------------------------------------------------------
\section{Conclusion}
\label{:rectangles:concl}

In this chapter, we have developed methods for answering the partial enclosure range searching problem on both axis-parallel and arbitrarily-oriented line segments with axis-parallel query rectangles. 
We have seen that the most challenging cases occur when both endpoints of a segment exist outside of the query region.
We have also seen how we can transform partial enclosure expressions into dual-spaces which can be easily queried with a half-plane.

There are several possibilities for future work.
Most notably is the condition that $\rho > 1/2$ for the arbitrary-orientation problem, which is the only problem with such a limitation presented in this thesis.
The limitation stems from our use of similar triangles anchored on the centrepoint of the segment.
When $\rho > 1/2$, the centrepoint of any segment satisfying the partial enclosure property will be found inside the query region, guaranteeing intersections between $Q$ and our similar triangles.

We would also like to reduce how many simultaneous partial enclosure expressions need to be checked. Having to check multiple expressions is a direct result of the uncertainty of which boundary of $Q$ a segment intersects. If we could directly identify the intersected boundaries with a better classification strategy, the number of nested levels required by our data structures could be reduced.

Finally, with the axis-parallel case, we are able to save a constant factor of space by sharing the classification steps between queries. 
In the arbitrary-orientation case, we perform our half-plane queries first as this saves us a $\log{n}$ factor in our asymptotic preprocessing needs. A side effect of this choice is that we cannot share the endpoint classification structures which are common to all cases.  
Some experimentation is needed to identify for which inputs this trade-off makes practical sense.
